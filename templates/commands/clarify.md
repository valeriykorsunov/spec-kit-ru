---
description: Выявление недостаточно определенных областей в текущей спецификации функции путем задания до 5 узконаправленных уточняющих вопросов и внесения ответов обратно в спецификацию.
handoffs: 
  - label: Создать технический план
    agent: speckit.plan
    prompt: Создай план для спецификации. Я использую...
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ДОЛЖНЫ** учитывать ввод пользователя перед продолжением (если он не пуст).

## План действий

Цель: Обнаружить и устранить двусмысленность или отсутствующие точки принятия решений в активной спецификации функции и записать уточнения непосредственно в файл спецификации.

Примечание: Этот процесс уточнения должен быть выполнен (и завершен) ДО вызова `/speckit.plan`. Если пользователь явно заявляет, что пропускает уточнение (например, для исследовательского прототипа), вы можете продолжить, но должны предупредить, что риск переделок в дальнейшем возрастает.

Шаги выполнения:

1. Запустите `{SCRIPT}` из корня репозитория **один раз** (комбинированный режим `--json --paths-only` / `-Json -PathsOnly`). Распарсите минимальные поля JSON payload:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - (Опционально захватите `IMPL_PLAN`, `TASKS` для будущих цепочек.)
   - Если парсинг JSON не удался, прервите выполнение и предложите пользователю перезапустить `/speckit.specify` или проверить окружение ветки функции.
   - Для одиночных кавычек в аргументах, таких как "I'm Groot", используйте escape-синтаксис: например, 'I'\''m Groot' (или двойные кавычки, если возможно: "I'm Groot").

2. Загрузите текущий файл спецификации. Выполните структурированное сканирование на наличие двусмысленностей и полноту покрытия, используя следующую таксономию. Для каждой категории отметьте статус: Ясно / Частично / Отсутствует. Создайте внутреннюю карту покрытия для приоритезации (не выводите сырую карту, если вопросы не будут заданы).

   Функциональный объем и поведение:
   - Основные цели пользователя и критерии успеха
   - Явные декларации о том, что не входит в объем
   - Различие ролей пользователей / персон

   Доменная и модель данных:
   - Сущности, атрибуты, связи
   - Правила идентификации и уникальности
   - Жизненный цикл / переходы состояний
   - Предположения об объеме данных / масштабе

   Взаимодействие и UX поток:
   - Критические пользовательские пути / последовательности
   - Состояния ошибки / пустоты / загрузки
   - Заметки по доступности или локализации

   Нефункциональные атрибуты качества:
   - Производительность (задержка, цели по пропускной способности)
   - Масштабируемость (горизонтальная/вертикальная, лимиты)
   - Надежность и доступность (время безотказной работы, ожидания по восстановлению)
   - Наблюдаемость (логирование, метрики, сигналы трассировки)
   - Безопасность и конфиденциальность (аутентификация/авторизация, защита данных, предположения об угрозах)
   - Соответствие требованиям / нормативные ограничения (если есть)

   Интеграция и внешние зависимости:
   - Внешние сервисы/API и режимы сбоев
   - Форматы импорта/экспорта данных
   - Предположения о протоколах/версионировании

   Граничные случаи и обработка сбоев:
   - Негативные сценарии
   - Ограничение скорости / троттлинг
   - Разрешение конфликтов (например, одновременное редактирование)

   Ограничения и компромиссы:
   - Технические ограничения (язык, хранилище, хостинг)
   - Явные компромиссы или отвергнутые альтернативы

   Терминология и согласованность:
   - Канонические термины глоссария
   - Избегаемые синонимы / устаревшие термины

   Сигналы завершения:
   - Тестируемость критериев приемки
   - Измеримые индикаторы в стиле Definition of Done

   Разное / Заполнители:
   - Маркеры TODO / нерешенные решения
   - Двусмысленные прилагательные ("надежный", "интуитивный"), не имеющие количественной оценки

   Для каждой категории со статусом Частично или Отсутствует добавьте возможность вопроса-кандидата, если:
   - Уточнение существенно не изменит стратегию реализации или валидации
   - Информацию лучше отложить до этапа планирования (отметьте внутренне)

3. Сгенерируйте (внутренне) приоритезированную очередь вопросов-кандидатов для уточнения (максимум 5). НЕ выводите их все сразу. Примените следующие ограничения:
    - Максимум 10 вопросов всего за сессию.
    - На каждый вопрос должен быть возможен ответ ЛИБО:
       - Коротким выбором из нескольких вариантов (2–5 четких, взаимоисключающих опций), ЛИБО
       - Ответом из одного слова / короткой фразы (явно ограничьте: "Ответ <=5 слов").
    - Включайте только те вопросы, ответы на которые существенно влияют на архитектуру, моделирование данных, декомпозицию задач, дизайн тестов, UX поведение, операционную готовность или валидацию соответствия.
    - Обеспечьте баланс покрытия категорий: попытайтесь сначала покрыть нерешенные категории с наибольшим влиянием; избегайте двух вопросов с низким влиянием, когда одна область с высоким влиянием (например, безопасность) не решена.
    - Исключите уже отвеченные вопросы, тривиальные стилистические предпочтения или детали выполнения уровня плана (если они не блокируют правильность).
    - Отдавайте предпочтение уточнениям, которые снижают риск переделок в дальнейшем или предотвращают неправильные приемочные тесты.
    - Если более 5 категорий остаются нерешенными, выберите топ-5 по эвристике (Влияние * Неопределенность).

4. Цикл последовательных вопросов (интерактивный):
    - Представляйте РОВНО ОДИН вопрос за раз.
    - Для вопросов с множественным выбором:
       - **Проанализируйте все варианты** и определите **наиболее подходящий вариант** на основе:
          - Лучших практик для типа проекта
          - Общих паттернов в похожих реализациях
          - Снижения рисков (безопасность, производительность, поддерживаемость)
          - Соответствия любым явным целям проекта или ограничениям, видимым в спецификации
       - Представьте ваш **рекомендованный вариант на видном месте** вверху с четким обоснованием (1-2 предложения, объясняющие, почему это лучший выбор).
       - Форматируйте как: `**Рекомендуется:** Вариант [X] - <обоснование>`
       - Затем выведите все варианты в виде Markdown таблицы:

       | Вариант | Описание |
       |--------|-------------|
       | A | <Описание варианта A> |
       | B | <Описание варианта B> |
       | C | <Описание варианта C> (добавьте D/E по необходимости до 5) |
       | Short | Предложите другой короткий ответ (<=5 слов) (Включайте только если уместна альтернатива в свободной форме) |

       - После таблицы добавьте: `Вы можете ответить буквой варианта (например, "A"), принять рекомендацию, написав "да" или "рекомендуемый", или предоставить свой короткий ответ.`
    - Для стиля короткого ответа (без значимых дискретных опций):
       - Предоставьте ваш **предложенный ответ** на основе лучших практик и контекста.
       - Форматируйте как: `**Предложено:** <ваш предложенный ответ> - <краткое обоснование>`
       - Затем выведите: `Формат: Короткий ответ (<=5 слов). Вы можете принять предложение, написав "да" или "предложено", или предоставить свой собственный ответ.`
    - После ответа пользователя:
       - Если пользователь отвечает "да", "рекомендуемый" или "предложено", используйте вашу ранее заявленную рекомендацию/предложение как ответ.
       - В противном случае проверьте, что ответ соответствует одному из вариантов или укладывается в ограничение <=5 слов.
       - Если ответ неоднозначен, попросите быстрого уточнения (счетчик все еще относится к тому же вопросу; не продвигайтесь вперед).
       - Как только ответ удовлетворителен, запишите его в рабочую память (пока не пишите на диск) и переходите к следующему вопросу в очереди.
    - Прекратите задавать вопросы, когда:
       - Все критические двусмысленности решены (оставшиеся элементы в очереди становятся ненужными), ИЛИ
       - Пользователь сигнализирует о завершении ("готово", "хорошо", "хватит"), ИЛИ
       - Вы достигли 5 заданных вопросов.
    - Никогда не раскрывайте будущие вопросы в очереди заранее.
    - Если в начале нет валидных вопросов, немедленно сообщите об отсутствии критических двусмысленностей.

5. Интеграция после КАЖДОГО принятого ответа (инкрементальный подход):
    - Поддерживайте в памяти представление спецификации (загруженное один раз при старте) плюс сырое содержимое файла.
    - Для первого интегрированного ответа в этой сессии:
       - Убедитесь, что раздел `## Clarifications` (Уточнения) существует (создайте его сразу после самого верхнего контекстного/обзорного раздела согласно шаблону спецификации, если он отсутствует).
       - Под ним создайте (если отсутствует) подзаголовок `### Session YYYY-MM-DD` для сегодняшнего дня.
    - Добавьте строку с маркером сразу после принятия: `- В: <вопрос> → О: <финальный ответ>`.
    - Затем немедленно примените уточнение к наиболее подходящему разделу(ам):
       - Функциональная двусмысленность → Обновите или добавьте пункт в Функциональные требования.
       - Взаимодействие с пользователем / различие акторов → Обновите подраздел Пользовательские истории или Акторы (если есть) с уточненной ролью, ограничением или сценарием.
       - Форма данных / сущности → Обновите Модель данных (добавьте поля, типы, связи), сохраняя порядок; кратко отметьте добавленные ограничения.
       - Нефункциональное ограничение → Добавьте/измените измеримые критерии в разделе Нефункциональные / Атрибуты качества (преобразуйте расплывчатое прилагательное в метрику или явную цель).
       - Граничный случай / негативный поток → Добавьте новый пункт в Граничные случаи / Обработка ошибок (или создайте такой подраздел, если шаблон предусматривает заполнитель для него).
       - Конфликт терминологии → Нормализуйте термин по всей спецификации; оставьте оригинал только при необходимости, добавив `(ранее упоминалось как "X")` один раз.
    - Если уточнение делает недействительным ранее двусмысленное утверждение, замените это утверждение вместо дублирования; не оставляйте устаревший противоречивый текст.
    - Сохраняйте файл спецификации ПОСЛЕ каждой интеграции, чтобы минимизировать риск потери контекста (атомарная перезапись).
    - Сохраняйте форматирование: не меняйте порядок несвязанных разделов; сохраняйте иерархию заголовков.
    - Держите каждое вставленное уточнение минимальным и тестируемым (избегайте повествовательного дрейфа).

6. Валидация (выполняется после КАЖДОЙ записи плюс финальный проход):
   - Сессия уточнений содержит ровно один пункт на каждый принятый ответ (без дубликатов).
   - Всего задано (принято) вопросов ≤ 5.
   - Обновленные разделы не содержат оставшихся расплывчатых заполнителей, которые новый ответ должен был разрешить.
   - Не осталось противоречивых ранних утверждений (сканируйте на наличие удаленных теперь недействительных альтернативных выборов).
   - Структура Markdown валидна; разрешены только новые заголовки: `## Clarifications`, `### Session YYYY-MM-DD`.
   - Согласованность терминологии: один и тот же канонический термин используется во всех обновленных разделах.

7. Запишите обновленную спецификацию обратно в `FEATURE_SPEC`.

8. Отчет о завершении (после окончания цикла вопросов или раннего завершения):
   - Количество заданных и отвеченных вопросов.
   - Путь к обновленной спецификации.
   - Затронутые разделы (список имен).
   - Таблица сводки покрытия, перечисляющая каждую категорию таксономии со Статусом: Решено (было Частично/Отсутствует и адресовано), Отложено (превышает квоту вопросов или лучше подходит для планирования), Ясно (уже достаточно), Нерешено (все еще Частично/Отсутствует, но низкое влияние).
   - Если остались Нерешенные или Отложенные, порекомендуйте, переходить ли к `/speckit.plan` или запустить `/speckit.clarify` снова позже после планирования.
   - Предложенная следующая команда.

Правила поведения:

- Если не найдено значимых двусмысленностей (или все потенциальные вопросы будут иметь низкое влияние), ответьте: "Критических двусмысленностей, стоящих формального уточнения, не обнаружено." и предложите продолжить.
- Если файл спецификации отсутствует, предложите пользователю сначала запустить `/speckit.specify` (не создавайте здесь новую спецификацию).
- Никогда не превышайте 5 всего заданных вопросов (повторные попытки уточнения для одного вопроса не считаются новыми вопросами).
- Избегайте спекулятивных вопросов о технологическом стеке, если их отсутствие не блокирует функциональную ясность.
- Уважайте сигналы раннего завершения от пользователя ("стоп", "готово", "продолжить").
- Если вопросы не заданы из-за полного покрытия, выведите компактную сводку покрытия (все категории Ясно), затем предложите продвигаться дальше.
- Если квота достигнута с оставшимися нерешенными категориями высокого влияния, явно отметьте их как Отложенные с обоснованием.

Контекст для приоритезации: {ARGS}
