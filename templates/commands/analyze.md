---
description: Выполните неразрушающий анализ согласованности и качества артефактов spec.md, plan.md и tasks.md после генерации задач.
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## Ввод пользователя

```text
$ARGUMENTS
```

Вы **ОБЯЗАНЫ** учитывать ввод пользователя перед продолжением (если он не пуст).

## Цель

Выявить несоответствия, дублирование, двусмысленности и недоопределенные элементы в трех основных артефактах (`spec.md`, `plan.md`, `tasks.md`) перед реализацией. Эта команда ДОЛЖНА запускаться только после того, как `/speckit.tasks` успешно создаст полный `tasks.md`.

## Рабочие ограничения

**СТРОГО ТОЛЬКО ДЛЯ ЧТЕНИЯ**: **Не** изменяйте никакие файлы. Выведите структурированный отчет об анализе. Предложите опциональный план исправления (пользователь должен явно одобрить его перед ручным вызовом любых команд редактирования).

**Авторитет Конституции**: Конституция проекта (`/memory/constitution.md`) **не подлежит обсуждению** в рамках этого анализа. Конфликты с конституцией автоматически считаются КРИТИЧЕСКИМИ и требуют корректировки спецификации, плана или задач — а не размывания, переосмысления или молчаливого игнорирования принципа. Если сам принцип требует изменения, это должно происходить в рамках отдельного, явного обновления конституции вне `/speckit.analyze`.

## Этапы выполнения

### 1. Инициализация контекста анализа

Запустите `{SCRIPT}` один раз из корня репозитория и распарсите JSON для `FEATURE_DIR` и `AVAILABLE_DOCS`. Получите абсолютные пути:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

Прервите выполнение с сообщением об ошибке, если отсутствует какой-либо обязательный файл (проинструктируйте пользователя запустить пропущенную команду-пререквизит).
Для одиночных кавычек в аргументах, например "I'm Groot", используйте синтаксис экранирования: например 'I'\''m Groot' (или двойные кавычки, если возможно: "I'm Groot").

### 2. Загрузка артефактов (Постепенное раскрытие)

Загрузите только минимально необходимый контекст из каждого артефакта:

**Из spec.md:**

- Обзор/Контекст
- Функциональные требования
- Нефункциональные требования
- Пользовательские истории (User Stories)
- Граничные случаи (Edge Cases) (если есть)

**Из plan.md:**

- Архитектура/выбор стека
- Ссылки на модель данных
- Фазы
- Технические ограничения

**Из tasks.md:**

- ID задач
- Описания
- Группировка по фазам
- Маркеры параллельности [P]
- Пути к упоминаемым файлам

**Из конституции:**

- Загрузите `/memory/constitution.md` для проверки принципов

### 3. Построение семантических моделей

Создайте внутренние представления (не включайте сырые артефакты в вывод):

- **Реестр требований**: Каждое функциональное + нефункциональное требование со стабильным ключом (получите слаг на основе повелительной фразы; например, "User can upload file" → `user-can-upload-file`)
- **Реестр пользовательских историй/действий**: Дискретные действия пользователя с критериями приемки
- **Карта покрытия задач**: Сопоставьте каждую задачу с одним или несколькими требованиями или историями (вывод по ключевым словам / явным шаблонам ссылок, таким как ID или ключевые фразы)
- **Набор правил конституции**: Извлеките названия принципов и нормативные утверждения MUST/SHOULD

### 4. Проходы обнаружения (Токен-эффективный анализ)

Сосредоточьтесь на находках с высоким сигналом. Ограничьтесь 50 находками всего; остальные агрегируйте в сводке переполнения.

#### A. Обнаружение дублирования

- Определите почти дублирующиеся требования
- Отметьте менее качественные формулировки для консолидации

#### B. Обнаружение двусмысленности

- Отметьте расплывчатые прилагательные (быстрый, масштабируемый, безопасный, интуитивный, надежный), не имеющие измеримых критериев
- Отметьте неразрешенные заполнители (TODO, TKTK, ???, `<placeholder>` и т.д.)

#### C. Недостаточная спецификация

- Требования с глаголами, но без объекта или измеримого результата
- Пользовательские истории без согласования с критериями приемки
- Задачи, ссылающиеся на файлы или компоненты, не определенные в спецификации/плане

#### D. Соответствие Конституции

- Любое требование или элемент плана, противоречащий принципу MUST
- Отсутствующие обязательные разделы или ворота качества (quality gates) из конституции

#### E. Пробелы в покрытии

- Требования с нулем связанных задач
- Задачи без сопоставленного требования/истории
- Нефункциональные требования, не отраженные в задачах (например, производительность, безопасность)

#### F. Непоследовательность

- Смещение терминологии (одно и то же понятие названо по-разному в разных файлах)
- Сущности данных, упомянутые в плане, но отсутствующие в спецификации (или наоборот)
- Противоречия в порядке задач (например, задачи интеграции перед задачами базовой настройки без примечания о зависимости)
- Конфликтующие требования (например, одно требует Next.js, а другое указывает Vue)

### 5. Назначение серьезности

Используйте эту эвристику для приоритизации находок:

- **CRITICAL (КРИТИЧЕСКИЙ)**: Нарушает MUST конституции, отсутствует основной артефакт спецификации или требование с нулевым покрытием, блокирующее базовую функциональность
- **HIGH (ВЫСОКИЙ)**: Дублирующее или конфликтующее требование, двусмысленный атрибут безопасности/производительности, непроверяемый критерий приемки
- **MEDIUM (СРЕДНИЙ)**: Смещение терминологии, отсутствие покрытия нефункциональных задач, недоопределенный граничный случай
- **LOW (НИЗКИЙ)**: Улучшения стиля/формулировок, незначительная избыточность, не влияющая на порядок выполнения

### 6. Создание компактного отчета об анализе

Выведите отчет в Markdown (без записи в файлы) следующей структуры:

## Отчет об анализе спецификации

| ID | Категория | Серьезность | Местоположение | Сводка | Рекомендация |
|----|-----------|-------------|----------------|--------|--------------|
| A1 | Дублирование | HIGH | spec.md:L120-134 | Два похожих требования ... | Объединить формулировки; оставить более четкую версию |

(Добавьте одну строку на находку; генерируйте стабильные ID с префиксом инициала категории.)

**Таблица сводки покрытия:**

| Ключ требования | Есть задача? | ID задач | Примечания |
|-----------------|--------------|----------|------------|

**Проблемы соответствия Конституции:** (если есть)

**Несопоставленные задачи:** (если есть)

**Метрики:**

- Всего требований
- Всего задач
- % Покрытия (требования с >=1 задачей)
- Количество двусмысленностей
- Количество дубликатов
- Количество критических проблем

### 7. Предоставление следующих действий

В конце отчета выведите краткий блок Следующих действий:

- Если есть CRITICAL проблемы: Рекомендуйте устранить их перед `/speckit.implement`
- Если только LOW/MEDIUM: Пользователь может продолжить, но предложите улучшения
- Предоставьте явные предложения команд: например, "Запустите /speckit.specify с уточнением", "Запустите /speckit.plan для корректировки архитектуры", "Вручную отредактируйте tasks.md, чтобы добавить покрытие для 'performance-metrics'"

### 8. Предложение исправления

Спросите пользователя: "Хотите ли вы, чтобы я предложил конкретные правки для исправления топ-N проблем?" (НЕ применяйте их автоматически.)

## Принципы работы

### Эффективность контекста

- **Минимум токенов с высоким сигналом**: Сосредоточьтесь на действенных находках, а не на исчерпывающей документации
- **Постепенное раскрытие**: Загружайте артефакты инкрементально; не вываливайте все содержимое в анализ
- **Токен-эффективный вывод**: Ограничьте таблицу находок 50 строками; суммируйте остальное
- **Детерминированные результаты**: Повторный запуск без изменений должен давать согласованные ID и подсчеты

### Руководство по анализу

- **НИКОГДА не изменяйте файлы** (это анализ только для чтения)
- **НИКОГДА не галлюцинируйте недостающие разделы** (если отсутствуют, сообщайте о них точно)
- **Приоритет нарушений конституции** (они всегда КРИТИЧЕСКИЕ)
- **Используйте примеры вместо исчерпывающих правил** (цитируйте конкретные случаи, а не общие шаблоны)
- **Сообщайте о нулевых проблемах корректно** (выдавайте отчет об успехе со статистикой покрытия)

## Контекст

{ARGS}
